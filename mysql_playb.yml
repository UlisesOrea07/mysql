---
- name: Install mysql
  hosts: mysql_servers
  become: true
  remote_user: centos
  vars_files:
    - vars/default.yml

  tasks:
  
  - name: get user
    become: false
    command: whoami
    state: present
    register: user
    delegate_to: localhost
    
  - name: remove host of known host
    known_hosts:
      path: /homne/{{ user.stdout }}/.ssh/known_hosts
      name: "{{ ansible_ssh_host }}"
      state: absent

  - name: Copy public key
    authorized_key: user=centos state=present key={{ lookup('file', '/home/{{ user.stdout }}/.ssh/id_rsa.pub') }}
  - name: Install mysql
    yum: name={{ item }} state=latest
    loop: ['mariadb', 'mariadb-server', 'python3', 'MySQL-python']
       
  - name: Start mysql service
    service: name=mariadb enabled=true state=started
  
  - name: Install firewalld
    yum: name=firewalld state=latest 

  - name: firewalld enable and running
    service: name=firewalld enabled=true state=started

  - name: add port
    firewalld: port=3306/tcp permanent=yes state=enabled immediate=yes

  - name: Removes all anonymous user accounts
    mysql_user: name='' host_all=yes state=absent

  - name: Remove the test database
    mysql_db: name=test state=absent

  - name: Create admin user for mysql
    mysql_user: user=admin password={{ mysql_root_password }} priv=*.*:ALL,GRANT host=% state=present
  
  - name: Create a new database 
    mysql_db: name=test4 state=present
